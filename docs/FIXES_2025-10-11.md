# Fixes Applied - October 11, 2025

## Database Schema Fix
**Issue**: Missing `embedding` column in `persistent_memories` table
**Solution**: 
- Added `embedding FLOAT8[]` column to existing database
- Created GIN index for fast semantic similarity searches
- Added migration to `init-db.sql` for future deployments

```sql
ALTER TABLE persistent_memories ADD COLUMN IF NOT EXISTS embedding FLOAT8[];
CREATE INDEX IF NOT EXISTS idx_memories_embedding ON persistent_memories USING GIN(embedding) WHERE embedding IS NOT NULL;
```

## TTS Timeout Increase
**Issue**: TTS services (Piper/Silero) were timing out after 30 seconds
**Solution**: Increased timeout from 30 seconds to 300 seconds (5 minutes)

**Changed in**: `mumble-bot/bot.py` line 2545 and 2552
```python
timeout=300  # 5 minutes for TTS generation (was 30 seconds)
```

## Connection Monitoring & Auto-Reconnection
**Issue**: Bot could disconnect from Mumble server and not reconnect
**Solution**: Added connection monitoring and automatic reconnection

**Features Added**:
1. **Initial Connection Retry**: Up to 10 attempts with 5-second delays
2. **Periodic Connection Checks**: Every 30 seconds
3. **Automatic Reconnection**: Detects disconnections and reconnects
4. **Error Recovery**: Catches exceptions in main loop and attempts graceful shutdown

**Changed in**: `mumble-bot/bot.py`
- Added `check_mumble_connection()` method
- Enhanced `run()` method with retry logic and monitoring
- Connection check interval: 30 seconds

## Additional Database Indexes
Added composite indexes for better query performance:
- `idx_memories_user_active_importance` on `persistent_memories(user_name, active, importance DESC)`
- `idx_conversation_user_session_timestamp` on `conversation_history(user_name, session_id, timestamp DESC)`
- `idx_schedule_user_date` on `schedule_events(user_name, event_date, active)`

## New Configuration Values
Added to database for advanced AI settings:
- `short_term_memory_limit`: 10 (increased from 3)
- `long_term_memory_limit`: 10 (increased from 3)
- `use_chain_of_thought`: false
- `use_semantic_memory_ranking`: true
- `use_response_validation`: false
- `enable_parallel_processing`: true

## Deployment
1. Database migrations applied to running instance
2. Mumble-bot container rebuilt with new code
3. Container restarted successfully
4. Bot confirmed connected to Mumble server
5. No more embedding column errors

## Verification
✅ Bot connected to Mumble server
✅ Database schema updated
✅ No embedding column errors
✅ TTS timeout increased to 5 minutes
✅ Connection monitoring active
✅ Health check server running on port 8080
✅ All services healthy

## Future Maintenance
- The `init-db.sql` file now includes all schema changes for fresh deployments
- Connection monitoring will automatically reconnect if Mumble connection drops
- TTS services have 5 minutes to generate audio before timing out
- Bot will survive temporary service outages







