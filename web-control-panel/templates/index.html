<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mumble AI Control Panel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .header h1 {
            margin-bottom: 0;
        }

        .nav-links {
            display: flex;
            gap: 15px;
        }

        .nav-link {
            background: white;
            color: #667eea;
            padding: 12px 25px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .nav-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            color: #667eea;
            font-size: 0.9em;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .stat-card .value {
            font-size: 2.5em;
            font-weight: bold;
            color: #333;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .panel {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .panel h2 {
            color: #667eea;
            margin-bottom: 20px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 600;
        }

        input, select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: background 0.3s;
        }

        button:hover {
            background: #5568d3;
        }

        button.danger {
            background: #e74c3c;
        }

        button.danger:hover {
            background: #c0392b;
        }

        .conversation-history {
            max-height: 500px;
            overflow-y: auto;
            background: #f8f9fa;
            border-radius: 5px;
            padding: 15px;
        }

        .message {
            margin-bottom: 15px;
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid;
        }

        .message.user {
            background: #e3f2fd;
            border-left-color: #2196f3;
        }

        .message.assistant {
            background: #f3e5f5;
            border-left-color: #9c27b0;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.85em;
            color: #666;
        }

        .message-content {
            color: #333;
        }

        textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: inherit;
            font-size: 1em;
            resize: vertical;
            min-height: 100px;
        }

        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            display: none;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            display: none;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .upcoming-events {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .upcoming-events h2 {
            color: #667eea;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .upcoming-events-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .event-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            transition: all 0.3s;
        }

        .event-item:hover {
            transform: translateX(5px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .event-item.high-importance {
            border-left-color: #f97316;
        }

        .event-item.critical-importance {
            border-left-color: #ef4444;
        }

        .event-info {
            flex: 1;
        }

        .event-title {
            font-weight: 600;
            font-size: 1.1em;
            color: #333;
            margin-bottom: 5px;
        }

        .event-details {
            font-size: 0.9em;
            color: #666;
        }

        .event-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
            white-space: nowrap;
        }

        .event-badge.normal {
            background: #dbeafe;
            color: #1e40af;
        }

        .event-badge.high {
            background: #fed7aa;
            color: #c2410c;
        }

        .event-badge.critical {
            background: #fee2e2;
            color: #991b1b;
        }

        .no-events {
            text-align: center;
            padding: 30px;
            color: #999;
            font-style: italic;
        }

        .view-all-link {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
            font-size: 0.9em;
        }

        .view-all-link:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéôÔ∏è Mumble AI Control Panel</h1>
            <div class="nav-links">
                <a href="/schedule" class="nav-link">üìÖ Schedule Manager</a>
            </div>
        </div>

        <!-- Statistics -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Total Messages</h3>
                <div class="value" id="stat-total">0</div>
            </div>
            <div class="stat-card">
                <h3>Unique Users</h3>
                <div class="value" id="stat-users">0</div>
            </div>
            <div class="stat-card">
                <h3>Voice Messages</h3>
                <div class="value" id="stat-voice">0</div>
            </div>
            <div class="stat-card">
                <h3>Text Messages</h3>
                <div class="value" id="stat-text">0</div>
            </div>
        </div>

        <!-- Upcoming Events -->
        <div class="upcoming-events">
            <h2>
                üìÖ Upcoming Events (Next 7 Days)
                <a href="/schedule" class="view-all-link">View All ‚Üí</a>
            </h2>
            <div id="upcomingEventsList" class="upcoming-events-list">
                <div class="no-events">Loading upcoming events...</div>
            </div>
        </div>

        <!-- Main Panels -->
        <div class="grid">
            <!-- Ollama Configuration -->
            <div class="panel">
                <h2>ü§ñ Ollama Configuration</h2>
                <div class="success-message" id="ollama-success">Settings saved successfully!</div>
                <div class="error-message" id="ollama-error">Error saving settings</div>

                <div class="form-group">
                    <label for="ollama-url">Ollama Server URL</label>
                    <input type="text" id="ollama-url" placeholder="http://host.docker.internal:11434">
                </div>

                <div class="form-group">
                    <label for="ollama-model">Model</label>
                    <select id="ollama-model">
                        <option value="">Loading...</option>
                    </select>
                </div>

                <button onclick="saveOllamaConfig()">Save Configuration</button>
                <button onclick="refreshModels()" style="margin-left: 10px; background: #3498db;">Refresh Models</button>
            </div>

            <!-- TTS Engine Configuration -->
            <div class="panel">
                <h2>üîä Text-to-Speech Engine</h2>
                <div class="success-message" id="tts-success">Settings saved successfully!</div>

                <div class="form-group">
                    <label for="tts-engine">TTS Engine</label>
                    <select id="tts-engine" onchange="changeTTSEngine(this.value)">
                        <option value="piper">Piper TTS (CPU)</option>
                        <option value="silero">Silero TTS (GPU - Faster)</option>
                    </select>
                    <p style="font-size: 0.85em; color: #666; margin-top: 5px;">
                        üí° Silero uses your GPU for much faster speech generation
                    </p>
                </div>

                <!-- Piper Voice Selection (hidden when Silero is selected) -->
                <div id="piper-voice-selection">
                    <div class="form-group">
                        <label for="piper-voice-select">Piper Voice</label>
                        <select id="piper-voice-select" onchange="selectPiperVoice(this.value)">
                            <option value="">Loading...</option>
                        </select>
                    </div>
                    <button onclick="previewPiperVoice()" style="background: #3498db;">üîä Preview Piper Voice</button>
                </div>

                <!-- Silero Voice Selection (hidden when Piper is selected) -->
                <div id="silero-voice-selection" style="display: none;">
                    <div class="form-group">
                        <label for="silero-voice-select">Silero Voice</label>
                        <select id="silero-voice-select" onchange="selectSileroVoice(this.value)">
                            <option value="">Loading...</option>
                        </select>
                    </div>
                    <button onclick="previewSileroVoice()" style="background: #3498db;">üîä Preview Silero Voice</button>
                </div>
            </div>

            <!-- Whisper Language Configuration -->
            <div class="panel">
                <h2>üé§ Whisper Speech Recognition</h2>
                <div class="success-message" id="whisper-success">Language setting saved successfully!</div>

                <div class="form-group">
                    <label for="whisper-language">Language</label>
                    <select id="whisper-language" onchange="saveWhisperLanguage()">
                        <option value="auto">Auto-detect</option>
                        <option value="en">English</option>
                        <option value="es">Spanish</option>
                        <option value="fr">French</option>
                        <option value="de">German</option>
                        <option value="it">Italian</option>
                        <option value="pt">Portuguese</option>
                        <option value="nl">Dutch</option>
                        <option value="ru">Russian</option>
                        <option value="zh">Chinese</option>
                        <option value="ja">Japanese</option>
                        <option value="ko">Korean</option>
                        <option value="ar">Arabic</option>
                        <option value="hi">Hindi</option>
                        <option value="pl">Polish</option>
                        <option value="tr">Turkish</option>
                        <option value="vi">Vietnamese</option>
                    </select>
                    <p style="font-size: 0.85em; color: #666; margin-top: 5px;">
                        üí° Tip: Select a specific language if auto-detect is choosing the wrong language.
                    </p>
                </div>
            </div>

            <!-- Bot Persona Configuration -->
            <div class="panel">
                <h2>ü§ñ Bot Persona</h2>
                <div class="success-message" id="persona-success">Persona saved successfully!</div>

                <div class="form-group">
                    <label for="persona-text">Persona Description</label>
                    <textarea id="persona-text" rows="6" placeholder="Describe how the bot should behave and talk. For example: 'You are a friendly assistant who speaks casually with humor.' Leave empty for default behavior."></textarea>
                    <p style="font-size: 0.85em; color: #666; margin-top: 5px;">
                        üí° Tip: Use the AI Enhance button to let the AI expand and improve your persona description.
                    </p>
                </div>

                <button onclick="savePersona()">Save Persona</button>
                <button onclick="enhancePersona()" style="margin-left: 10px; background: #e74c3c;">‚ú® AI Enhance</button>
                <button onclick="clearPersona()" style="margin-left: 10px; background: #95a5a6;">Clear</button>
            </div>
        </div>

        <!-- Conversation History -->
        <div class="panel full-width">
            <h2>üí¨ Conversation History</h2>
            <div style="margin-bottom: 15px;">
                <button onclick="loadConversations()">Refresh</button>
                <button class="danger" onclick="resetConversations()" style="float: right;">Clear All History</button>
            </div>

            <div class="conversation-history" id="conversation-history">
                <p>Loading conversations...</p>
            </div>
        </div>

        <!-- Persistent Memories -->
        <div class="panel full-width">
            <h2>üß† Persistent Memories</h2>
            <div style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center;">
                <select id="user-filter" onchange="loadMemories()" style="padding: 8px; flex: 1;">
                    <option value="">All Users</option>
                </select>
                <select id="category-filter" onchange="loadMemories()" style="padding: 8px; flex: 1;">
                    <option value="">All Categories</option>
                    <option value="schedule">üìÖ Schedule</option>
                    <option value="fact">üí° Fact</option>
                    <option value="task">‚úì Task</option>
                    <option value="preference">‚ù§Ô∏è Preference</option>
                    <option value="reminder">‚è∞ Reminder</option>
                    <option value="other">üìå Other</option>
                </select>
                <button onclick="loadMemories()">Refresh</button>
                <button onclick="showAddMemoryForm()">+ Add Memory</button>
            </div>

            <div id="add-memory-form" style="display: none; background: #f5f5f5; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <h3 style="margin-bottom: 10px;">Add New Memory</h3>
                <input type="text" id="new-memory-user" placeholder="User Name" style="width: 100%; padding: 8px; margin-bottom: 10px;">
                <select id="new-memory-category" style="width: 100%; padding: 8px; margin-bottom: 10px;">
                    <option value="schedule">üìÖ Schedule</option>
                    <option value="fact">üí° Fact</option>
                    <option value="task">‚úì Task</option>
                    <option value="preference">‚ù§Ô∏è Preference</option>
                    <option value="reminder">‚è∞ Reminder</option>
                    <option value="other">üìå Other</option>
                </select>
                <textarea id="new-memory-content" placeholder="Memory content" style="width: 100%; padding: 8px; margin-bottom: 10px; min-height: 80px;"></textarea>
                <input type="number" id="new-memory-importance" placeholder="Importance (1-10)" min="1" max="10" value="5" style="width: 100%; padding: 8px; margin-bottom: 10px;">
                <div style="display: flex; gap: 10px;">
                    <button onclick="addMemory()">Save Memory</button>
                    <button onclick="cancelAddMemory()" class="secondary">Cancel</button>
                </div>
            </div>

            <div id="memories-list" style="max-height: 500px; overflow-y: auto;">
                <p>Loading memories...</p>
            </div>
        </div>

        <!-- Email Summary Settings -->
        <div class="panel full-width">
            <h2>üìß Email Summary Settings</h2>
            <p style="margin-bottom: 15px; color: #666;">Configure daily email summaries of conversation history</p>

            <div class="grid" style="grid-template-columns: 1fr 1fr;">
                <!-- SMTP Configuration -->
                <div>
                    <h3 style="color: #667eea; margin-bottom: 15px;">SMTP Configuration</h3>
                    <div class="form-group">
                        <label>SMTP Host</label>
                        <input type="text" id="email-smtp-host" placeholder="mail.example.com">
                    </div>
                    <div class="form-group">
                        <label>SMTP Port</label>
                        <input type="number" id="email-smtp-port" placeholder="25">
                    </div>
                    <div class="form-group">
                        <label>SMTP Username (optional)</label>
                        <input type="text" id="email-smtp-username" placeholder="username">
                    </div>
                    <div class="form-group">
                        <label>SMTP Password (optional)</label>
                        <input type="password" id="email-smtp-password" placeholder="password">
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="email-smtp-tls" style="width: auto;">
                            Use TLS
                        </label>
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="email-smtp-ssl" style="width: auto;">
                            Use SSL
                        </label>
                    </div>
                </div>

                <!-- Email Settings -->
                <div>
                    <h3 style="color: #667eea; margin-bottom: 15px;">Email Settings</h3>
                    <div class="form-group">
                        <label>From Email</label>
                        <input type="email" id="email-from" placeholder="mumble-ai@example.com">
                    </div>
                    <div class="form-group">
                        <label>Recipient Email</label>
                        <input type="email" id="email-recipient" placeholder="your-email@example.com">
                    </div>
                    <div class="form-group">
                        <label>Summary Time (24-hour format)</label>
                        <input type="time" id="email-summary-time" value="22:00">
                    </div>
                    <div class="form-group">
                        <label>Timezone</label>
                        <select id="email-timezone">
                            <option value="America/New_York">America/New York (EST/EDT)</option>
                            <option value="America/Chicago">America/Chicago (CST/CDT)</option>
                            <option value="America/Denver">America/Denver (MST/MDT)</option>
                            <option value="America/Los_Angeles">America/Los Angeles (PST/PDT)</option>
                            <option value="UTC">UTC</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="email-enabled" style="width: auto;">
                            Enable Daily Summaries
                        </label>
                    </div>
                    <div class="form-group" id="email-last-sent-display" style="padding: 10px; background: #f5f5f5; border-radius: 5px; display: none;">
                        <strong>Last Sent:</strong> <span id="email-last-sent">Never</span>
                    </div>
                </div>
            </div>

            <div class="grid" style="grid-template-columns: 1fr 1fr; margin-top: 20px;">
                <!-- IMAP Configuration -->
                <div>
                    <h3 style="color: #667eea; margin-bottom: 15px;">üì• IMAP Configuration (Email Receiving)</h3>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="email-imap-enabled" style="width: auto;">
                            Enable IMAP Email Receiving
                        </label>
                    </div>
                    <div class="form-group">
                        <label>IMAP Host</label>
                        <input type="text" id="email-imap-host" placeholder="imap.gmail.com">
                    </div>
                    <div class="form-group">
                        <label>IMAP Port</label>
                        <input type="number" id="email-imap-port" placeholder="993" value="993">
                    </div>
                    <div class="form-group">
                        <label>IMAP Username</label>
                        <input type="text" id="email-imap-username" placeholder="your-email@example.com">
                    </div>
                    <div class="form-group">
                        <label>IMAP Password</label>
                        <input type="password" id="email-imap-password" placeholder="password or app password">
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="email-imap-ssl" style="width: auto;" checked>
                            Use SSL
                        </label>
                    </div>
                    <div class="form-group">
                        <label>Mailbox/Folder</label>
                        <input type="text" id="email-imap-mailbox" placeholder="INBOX" value="INBOX">
                    </div>
                </div>

                <!-- AI Reply Configuration -->
                <div>
                    <h3 style="color: #667eea; margin-bottom: 15px;">ü§ñ AI Auto-Reply Settings</h3>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="email-auto-reply-enabled" style="width: auto;">
                            Enable AI Auto-Reply
                        </label>
                        <small style="color: #666; display: block; margin-top: 5px;">
                            When enabled, the AI will automatically reply to incoming emails using Ollama
                        </small>
                    </div>
                    <div class="form-group">
                        <label>Check Interval (seconds)</label>
                        <input type="number" id="email-check-interval" placeholder="300" value="300" min="60">
                        <small style="color: #666;">How often to check for new emails (default: 300 = 5 minutes)</small>
                    </div>
                    <div class="form-group">
                        <label>Reply Signature (optional)</label>
                        <textarea id="email-reply-signature" rows="3" placeholder="Best regards,&#10;AI Assistant&#10;Mumble AI System"></textarea>
                        <small style="color: #666;">Will be appended to all AI-generated email replies</small>
                        <button onclick="generateEmailSignature()" style="margin-top: 8px; background: #9b59b6; padding: 8px 16px; font-size: 14px;">
                            ü§ñ Generate Signature from Persona
                        </button>
                    </div>
                    <div class="form-group" id="email-last-checked-display" style="padding: 10px; background: #f5f5f5; border-radius: 5px; display: none;">
                        <strong>Last Checked:</strong> <span id="email-last-checked">Never</span>
                    </div>
                </div>
            </div>

            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button onclick="saveEmailSettings()">Save Email Settings</button>
                <button onclick="sendTestEmail()">Send Test Email</button>
                <button onclick="loadEmailSettings()" class="secondary">Refresh</button>
            </div>

            <!-- Email User Mappings Section -->
            <div style="margin-top: 40px;">
                <h3 style="color: #667eea; margin-bottom: 15px;">üìß Email-to-User Mappings</h3>
                <p style="margin-bottom: 15px; color: #666;">Map email addresses to specific users so the bot uses their memories and schedule when replying.</p>

                <div style="margin-bottom: 15px;">
                    <button onclick="showAddMappingForm()">+ Add New Mapping</button>
                </div>

                <!-- Add Mapping Form (hidden by default) -->
                <div id="add-mapping-form" style="display: none; background: #f5f5f5; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="margin-top: 0;">Add Email Mapping</h4>
                    <div class="form-group">
                        <label>Email Address</label>
                        <input type="email" id="new-mapping-email" placeholder="john@example.com">
                    </div>
                    <div class="form-group">
                        <label>User Name</label>
                        <input type="text" id="new-mapping-user" placeholder="Charles">
                        <small style="color: #666;">The user name from your system (used to look up memories and schedule)</small>
                    </div>
                    <div class="form-group">
                        <label>Notes (optional)</label>
                        <input type="text" id="new-mapping-notes" placeholder="e.g., My personal email">
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="addEmailMapping()">Add Mapping</button>
                        <button onclick="cancelAddMapping()" class="secondary">Cancel</button>
                    </div>
                </div>

                <!-- Mappings List -->
                <div id="email-mappings-list" style="margin-top: 20px;">
                    <!-- Populated by JavaScript -->
                </div>
            </div>

            <!-- Email Logs Section -->
            <div style="margin-top: 40px;">
                <h3 style="color: #667eea; margin-bottom: 15px;">üì¨ Email Activity Logs</h3>
                <p style="margin-bottom: 15px; color: #666;">View all email activity including received emails and sent replies.</p>

                <!-- Filters -->
                <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div class="form-group" style="margin: 0;">
                            <label>Direction</label>
                            <select id="log-filter-direction" onchange="loadEmailLogs()">
                                <option value="">All</option>
                                <option value="received">Received</option>
                                <option value="sent">Sent</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label>Type</label>
                            <select id="log-filter-type" onchange="loadEmailLogs()">
                                <option value="">All</option>
                                <option value="reply">Reply</option>
                                <option value="summary">Summary</option>
                                <option value="test">Test</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label>Status</label>
                            <select id="log-filter-status" onchange="loadEmailLogs()">
                                <option value="">All</option>
                                <option value="success">Success</option>
                                <option value="error">Error</option>
                            </select>
                        </div>
                        <div style="display: flex; align-items: flex-end;">
                            <button onclick="loadEmailLogs()" class="secondary">üîÑ Refresh</button>
                        </div>
                    </div>
                </div>

                <!-- Logs List -->
                <div id="email-logs-list" style="margin-top: 20px;">
                    <!-- Populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Load initial data
        document.addEventListener('DOMContentLoaded', function() {
            loadStats();
            loadOllamaConfig();
            loadUsers();
            loadTTSEngine();
            loadWhisperLanguage();
            loadPersona();
            loadConversations();
            loadMemories();
            loadEmailSettings();
            loadEmailMappings();
            loadEmailLogs();
            loadUpcomingEvents();

            // Refresh stats and events periodically
            setInterval(loadStats, 10000);
            setInterval(loadUpcomingEvents, 30000);
        });

        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();

                document.getElementById('stat-total').textContent = data.total_messages;
                document.getElementById('stat-users').textContent = data.unique_users;
                document.getElementById('stat-voice').textContent = data.voice_messages;
                document.getElementById('stat-text').textContent = data.text_messages;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadUpcomingEvents() {
            try {
                const response = await fetch('/api/schedule/upcoming?days=7&limit=5');
                const events = await response.json();

                const container = document.getElementById('upcomingEventsList');

                if (events.length === 0) {
                    container.innerHTML = '<div class="no-events">No upcoming events in the next 7 days</div>';
                    return;
                }

                container.innerHTML = events.map(event => {
                    // Parse date as local date, not UTC
                    const dateParts = event.event_date.split('-');
                    const date = new Date(dateParts[0], dateParts[1] - 1, dateParts[2]);
                    const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                    const timeStr = event.event_time ? ` at ${event.event_time.substring(0, 5)}` : '';

                    const importance = event.importance;
                    let importanceClass = 'normal';
                    let importanceBadge = 'Normal';

                    if (importance >= 8) {
                        importanceClass = 'critical-importance';
                        importanceBadge = 'Critical';
                    } else if (importance >= 5) {
                        importanceClass = 'high-importance';
                        importanceBadge = 'High';
                    }

                    return `
                        <div class="event-item ${importanceClass}">
                            <div class="event-info">
                                <div class="event-title">${event.title}</div>
                                <div class="event-details">
                                    ${event.user_name} ‚Ä¢ ${dateStr}${timeStr}
                                    ${event.description ? ' ‚Ä¢ ' + event.description : ''}
                                </div>
                            </div>
                            <span class="event-badge ${importanceClass.replace('-importance', '')}">${importanceBadge}</span>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading upcoming events:', error);
                document.getElementById('upcomingEventsList').innerHTML =
                    '<div class="no-events">Error loading upcoming events</div>';
            }
        }

        async function loadOllamaConfig() {
            try {
                const response = await fetch('/api/ollama/config');
                const data = await response.json();

                document.getElementById('ollama-url').value = data.url;

                // Load available models
                await refreshModels();

                // Set current model
                document.getElementById('ollama-model').value = data.model;
            } catch (error) {
                console.error('Error loading Ollama config:', error);
            }
        }

        async function refreshModels() {
            try {
                const response = await fetch('/api/ollama/models');
                const data = await response.json();

                const select = document.getElementById('ollama-model');
                const currentValue = select.value;

                select.innerHTML = '';

                if (data.models && data.models.length > 0) {
                    data.models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model;
                        option.textContent = model;
                        select.appendChild(option);
                    });

                    select.value = currentValue;
                } else {
                    select.innerHTML = '<option value="">No models found</option>';
                }
            } catch (error) {
                console.error('Error refreshing models:', error);
                document.getElementById('ollama-error').textContent = 'Error loading models';
                document.getElementById('ollama-error').style.display = 'block';
            }
        }

        async function saveOllamaConfig() {
            const url = document.getElementById('ollama-url').value;
            const model = document.getElementById('ollama-model').value;

            try {
                const response = await fetch('/api/ollama/config', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({url, model})
                });

                if (response.ok) {
                    const successMsg = document.getElementById('ollama-success');
                    successMsg.style.display = 'block';
                    setTimeout(() => successMsg.style.display = 'none', 3000);
                }
            } catch (error) {
                console.error('Error saving config:', error);
                const errorMsg = document.getElementById('ollama-error');
                errorMsg.style.display = 'block';
                setTimeout(() => errorMsg.style.display = 'none', 3000);
            }
        }

        async function loadTTSEngine() {
            try {
                const response = await fetch('/api/tts/engine');
                const data = await response.json();
                document.getElementById('tts-engine').value = data.engine || 'piper';

                // Load voices for the selected engine
                if (data.engine === 'silero') {
                    document.getElementById('piper-voice-selection').style.display = 'none';
                    document.getElementById('silero-voice-selection').style.display = 'block';
                    await loadSileroVoices();
                } else {
                    document.getElementById('piper-voice-selection').style.display = 'block';
                    document.getElementById('silero-voice-selection').style.display = 'none';
                    await loadPiperVoices();
                }
            } catch (error) {
                console.error('Error loading TTS engine:', error);
            }
        }

        async function changeTTSEngine(engine) {
            try {
                const response = await fetch('/api/tts/engine', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({engine})
                });

                if (response.ok) {
                    // Show/hide appropriate voice selection
                    if (engine === 'silero') {
                        document.getElementById('piper-voice-selection').style.display = 'none';
                        document.getElementById('silero-voice-selection').style.display = 'block';
                        await loadSileroVoices();
                    } else {
                        document.getElementById('piper-voice-selection').style.display = 'block';
                        document.getElementById('silero-voice-selection').style.display = 'none';
                        await loadPiperVoices();
                    }

                    const successMsg = document.getElementById('tts-success');
                    successMsg.style.display = 'block';
                    setTimeout(() => successMsg.style.display = 'none', 3000);
                }
            } catch (error) {
                console.error('Error changing TTS engine:', error);
            }
        }

        async function loadPiperVoices() {
            try {
                const [voicesResp, currentResp] = await Promise.all([
                    fetch('/api/piper/voices'),
                    fetch('/api/piper/current')
                ]);

                const voicesData = await voicesResp.json();
                const currentData = await currentResp.json();

                const select = document.getElementById('piper-voice-select');
                select.innerHTML = '';

                if (voicesData.voices.length === 0) {
                    select.innerHTML = '<option>No voices available</option>';
                    return;
                }

                // Group voices by region
                const voicesByRegion = {};
                voicesData.voices.forEach(voice => {
                    if (!voicesByRegion[voice.region]) {
                        voicesByRegion[voice.region] = [];
                    }
                    voicesByRegion[voice.region].push(voice);
                });

                // Create optgroups for each region
                Object.keys(voicesByRegion).sort().forEach(region => {
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = region;

                    voicesByRegion[region].forEach(voice => {
                        const option = document.createElement('option');
                        option.value = voice.name;

                        // Format: speaker (Gender, quality)
                        const genderLabel = voice.gender !== 'Neutral' ? ` - ${voice.gender}` : '';
                        option.textContent = `${voice.speaker}${genderLabel} (${voice.quality})`;

                        if (voice.name === currentData.voice) {
                            option.selected = true;
                        }
                        optgroup.appendChild(option);
                    });

                    select.appendChild(optgroup);
                });
            } catch (error) {
                console.error('Error loading Piper voices:', error);
            }
        }

        async function loadSileroVoices() {
            try {
                const [voicesResp, currentResp] = await Promise.all([
                    fetch('/api/silero/voices'),
                    fetch('/api/silero/current')
                ]);

                const voicesData = await voicesResp.json();
                const currentData = await currentResp.json();

                const select = document.getElementById('silero-voice-select');
                select.innerHTML = '';

                if (!voicesData.voices || voicesData.voices.length === 0) {
                    select.innerHTML = '<option>No voices available</option>';
                    return;
                }

                // Group voices by gender
                const voicesByGender = {female: [], male: []};
                voicesData.voices.forEach(voice => {
                    if (voice.gender === 'female') {
                        voicesByGender.female.push(voice);
                    } else if (voice.gender === 'male') {
                        voicesByGender.male.push(voice);
                    }
                });

                // Create optgroups for each gender
                ['female', 'male'].forEach(gender => {
                    if (voicesByGender[gender].length > 0) {
                        const optgroup = document.createElement('optgroup');
                        optgroup.label = gender.charAt(0).toUpperCase() + gender.slice(1) + ' Voices';

                        voicesByGender[gender].forEach(voice => {
                            const option = document.createElement('option');
                            option.value = voice.id;
                            option.textContent = `${voice.id} - ${voice.description}`;

                            if (voice.id === currentData.voice) {
                                option.selected = true;
                            }
                            optgroup.appendChild(option);
                        });

                        select.appendChild(optgroup);
                    }
                });
            } catch (error) {
                console.error('Error loading Silero voices:', error);
            }
        }

        async function selectPiperVoice(voice) {
            if (!voice) return;

            try {
                const response = await fetch('/api/piper/current', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({voice})
                });

                if (response.ok) {
                    const successMsg = document.getElementById('tts-success');
                    successMsg.style.display = 'block';
                    setTimeout(() => successMsg.style.display = 'none', 3000);
                }
            } catch (error) {
                console.error('Error selecting Piper voice:', error);
            }
        }

        async function selectSileroVoice(voice) {
            if (!voice) return;

            try {
                const response = await fetch('/api/silero/current', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({voice})
                });

                if (response.ok) {
                    const successMsg = document.getElementById('tts-success');
                    successMsg.style.display = 'block';
                    setTimeout(() => successMsg.style.display = 'none', 3000);
                }
            } catch (error) {
                console.error('Error selecting Silero voice:', error);
            }
        }

        async function previewPiperVoice() {
            const voice = document.getElementById('piper-voice-select').value;
            if (!voice) {
                alert('Please select a voice first');
                return;
            }

            const btn = event.target;
            btn.disabled = true;
            btn.textContent = '‚è≥ Generating...';

            try {
                const response = await fetch('/api/piper/preview', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({voice})
                });

                if (response.ok) {
                    const audioBlob = await response.blob();
                    const audioUrl = URL.createObjectURL(audioBlob);
                    const audio = new Audio(audioUrl);
                    audio.play();
                } else {
                    alert('Error generating preview');
                }
            } catch (error) {
                console.error('Error previewing voice:', error);
                alert('Error previewing voice');
            } finally {
                btn.disabled = false;
                btn.textContent = 'üîä Preview Piper Voice';
            }
        }

        async function previewSileroVoice() {
            const voice = document.getElementById('silero-voice-select').value;
            if (!voice) {
                alert('Please select a voice first');
                return;
            }

            const btn = event.target;
            btn.disabled = true;
            btn.textContent = '‚è≥ Generating...';

            try {
                const response = await fetch('/api/silero/preview', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({voice})
                });

                if (response.ok) {
                    const audioBlob = await response.blob();
                    const audioUrl = URL.createObjectURL(audioBlob);
                    const audio = new Audio(audioUrl);
                    audio.play();
                } else {
                    alert('Error generating preview');
                }
            } catch (error) {
                console.error('Error previewing voice:', error);
                alert('Error previewing voice');
            } finally {
                btn.disabled = false;
                btn.textContent = 'üîä Preview Silero Voice';
            }
        }

        async function loadPersona() {
            try {
                const response = await fetch('/api/persona');
                const data = await response.json();
                document.getElementById('persona-text').value = data.persona || '';
            } catch (error) {
                console.error('Error loading persona:', error);
            }
        }

        async function savePersona() {
            const persona = document.getElementById('persona-text').value;

            try {
                const response = await fetch('/api/persona', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({persona})
                });

                if (response.ok) {
                    const successMsg = document.getElementById('persona-success');
                    successMsg.style.display = 'block';
                    setTimeout(() => successMsg.style.display = 'none', 3000);
                }
            } catch (error) {
                console.error('Error saving persona:', error);
            }
        }

        async function enhancePersona() {
            const currentPersona = document.getElementById('persona-text').value.trim();

            if (!currentPersona) {
                alert('Please enter a basic persona description first, then click AI Enhance to expand it.');
                return;
            }

            const enhanceBtn = event.target;
            enhanceBtn.disabled = true;
            enhanceBtn.textContent = '‚è≥ Enhancing...';

            try {
                const response = await fetch('/api/persona/enhance', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({persona: currentPersona})
                });

                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('persona-text').value = data.enhanced_persona;

                    const successMsg = document.getElementById('persona-success');
                    successMsg.textContent = 'Persona enhanced successfully!';
                    successMsg.style.display = 'block';
                    setTimeout(() => {
                        successMsg.style.display = 'none';
                        successMsg.textContent = 'Persona saved successfully!';
                    }, 3000);
                } else {
                    alert('Error enhancing persona. Make sure Ollama is running.');
                }
            } catch (error) {
                console.error('Error enhancing persona:', error);
                alert('Error enhancing persona. Make sure Ollama is running.');
            } finally {
                enhanceBtn.disabled = false;
                enhanceBtn.textContent = '‚ú® AI Enhance';
            }
        }

        function clearPersona() {
            if (confirm('Are you sure you want to clear the persona?')) {
                document.getElementById('persona-text').value = '';
                savePersona();
            }
        }

        async function loadWhisperLanguage() {
            try {
                const response = await fetch('/api/whisper/language');
                const data = await response.json();
                document.getElementById('whisper-language').value = data.language || 'auto';
            } catch (error) {
                console.error('Error loading whisper language:', error);
            }
        }

        async function saveWhisperLanguage() {
            const language = document.getElementById('whisper-language').value;

            try {
                const response = await fetch('/api/whisper/language', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({language})
                });

                if (response.ok) {
                    const successMsg = document.getElementById('whisper-success');
                    successMsg.style.display = 'block';
                    setTimeout(() => successMsg.style.display = 'none', 3000);
                }
            } catch (error) {
                console.error('Error saving whisper language:', error);
            }
        }

        async function loadConversations() {
            try {
                const response = await fetch('/api/conversations?limit=50');
                const data = await response.json();

                const container = document.getElementById('conversation-history');
                container.innerHTML = '';

                if (data.conversations.length === 0) {
                    container.innerHTML = '<p>No conversation history yet</p>';
                    return;
                }

                data.conversations.reverse().forEach(conv => {
                    const msg = document.createElement('div');
                    msg.className = `message ${conv.role}`;

                    const timestamp = new Date(conv.timestamp).toLocaleString();

                    msg.innerHTML = `
                        <div class="message-header">
                            <span><strong>${conv.user_name}</strong> (${conv.role})</span>
                            <span>${conv.message_type} | ${timestamp}</span>
                        </div>
                        <div class="message-content">${conv.message}</div>
                    `;

                    container.appendChild(msg);
                });

                // Scroll to bottom
                container.scrollTop = container.scrollHeight;
            } catch (error) {
                console.error('Error loading conversations:', error);
            }
        }

        async function resetConversations() {
            if (!confirm('Are you sure you want to delete all conversation history? This cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch('/api/conversations/reset', {method: 'POST'});
                const data = await response.json();

                if (data.success) {
                    alert(`Deleted ${data.deleted} messages`);
                    loadConversations();
                    loadStats();
                }
            } catch (error) {
                console.error('Error resetting conversations:', error);
            }
        }

        // Persistent Memories Functions
        async function loadUsers() {
            try {
                const response = await fetch('/api/users');
                const users = await response.json();

                const select = document.getElementById('user-filter');
                // Keep the "All Users" option
                select.innerHTML = '<option value="">All Users</option>';

                users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user;
                    option.textContent = user;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        async function loadMemories() {
            try {
                const userFilter = document.getElementById('user-filter').value;
                const categoryFilter = document.getElementById('category-filter').value;

                let url = '/api/memories?';
                if (userFilter) url += `user=${encodeURIComponent(userFilter)}&`;
                if (categoryFilter) url += `category=${encodeURIComponent(categoryFilter)}`;

                const response = await fetch(url);
                const memories = await response.json();

                const container = document.getElementById('memories-list');

                if (memories.length === 0) {
                    container.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">No memories found</p>';
                    return;
                }

                const categoryIcons = {
                    'schedule': 'üìÖ',
                    'fact': 'üí°',
                    'task': '‚úì',
                    'preference': '‚ù§Ô∏è',
                    'reminder': '‚è∞',
                    'other': 'üìå'
                };

                const importanceColors = {
                    1: '#95a5a6', 2: '#95a5a6', 3: '#95a5a6',
                    4: '#3498db', 5: '#3498db', 6: '#3498db',
                    7: '#f39c12', 8: '#f39c12',
                    9: '#e74c3c', 10: '#e74c3c'
                };

                container.innerHTML = memories.map(mem => `
                    <div style="background: white; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid ${importanceColors[mem.importance]};">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                            <div>
                                <span style="background: #ecf0f1; padding: 3px 8px; border-radius: 4px; font-size: 0.85em; margin-right: 8px;">
                                    ${categoryIcons[mem.category]} ${mem.category.toUpperCase()}
                                </span>
                                <span style="color: #7f8c8d; font-size: 0.9em;">${mem.user_name}</span>
                                <span style="color: #bdc3c7; font-size: 0.85em; margin-left: 10px;">
                                    ${new Date(mem.extracted_at).toLocaleDateString()} ${new Date(mem.extracted_at).toLocaleTimeString()}
                                </span>
                            </div>
                            <div>
                                <span style="background: ${importanceColors[mem.importance]}; color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.85em; margin-right: 8px;">
                                    ${mem.importance}/10
                                </span>
                                <button onclick="deleteMemory(${mem.id})" style="background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.85em;">
                                    Delete
                                </button>
                            </div>
                        </div>
                        <div style="color: #2c3e50; line-height: 1.5;">${mem.content}</div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading memories:', error);
                document.getElementById('memories-list').innerHTML = '<p style="color: red;">Error loading memories</p>';
            }
        }

        function showAddMemoryForm() {
            document.getElementById('add-memory-form').style.display = 'block';
        }

        function cancelAddMemory() {
            document.getElementById('add-memory-form').style.display = 'none';
            // Clear form
            document.getElementById('new-memory-user').value = '';
            document.getElementById('new-memory-content').value = '';
            document.getElementById('new-memory-importance').value = '5';
        }

        async function addMemory() {
            try {
                const userName = document.getElementById('new-memory-user').value.trim();
                const category = document.getElementById('new-memory-category').value;
                const content = document.getElementById('new-memory-content').value.trim();
                const importance = parseInt(document.getElementById('new-memory-importance').value);

                if (!userName || !content) {
                    alert('Please fill in user name and content');
                    return;
                }

                const response = await fetch('/api/memories', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        user_name: userName,
                        category: category,
                        content: content,
                        importance: importance
                    })
                });

                if (response.ok) {
                    cancelAddMemory();
                    loadMemories();
                    loadUsers(); // Refresh users list
                } else {
                    alert('Error adding memory');
                }
            } catch (error) {
                console.error('Error adding memory:', error);
                alert('Error adding memory');
            }
        }

        async function deleteMemory(id) {
            if (!confirm('Are you sure you want to delete this memory?')) {
                return;
            }

            try {
                const response = await fetch(`/api/memories/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    loadMemories();
                } else {
                    alert('Error deleting memory');
                }
            } catch (error) {
                console.error('Error deleting memory:', error);
                alert('Error deleting memory');
            }
        }

        // Email Settings Functions
        async function loadEmailSettings() {
            try {
                const response = await fetch('/api/email/settings');
                const data = await response.json();

                // SMTP settings
                document.getElementById('email-smtp-host').value = data.smtp_host || '';
                document.getElementById('email-smtp-port').value = data.smtp_port || 25;
                document.getElementById('email-smtp-username').value = data.smtp_username || '';
                document.getElementById('email-smtp-password').value = ''; // Don't populate password
                document.getElementById('email-smtp-tls').checked = data.smtp_use_tls || false;
                document.getElementById('email-smtp-ssl').checked = data.smtp_use_ssl || false;
                document.getElementById('email-from').value = data.from_email || '';
                document.getElementById('email-recipient').value = data.recipient_email || '';

                // Daily summary settings
                document.getElementById('email-summary-time').value = data.summary_time ? data.summary_time.substring(0, 5) : '22:00';
                document.getElementById('email-timezone').value = data.timezone || 'America/New_York';
                document.getElementById('email-enabled').checked = data.daily_summary_enabled || false;

                // IMAP settings
                document.getElementById('email-imap-enabled').checked = data.imap_enabled || false;
                document.getElementById('email-imap-host').value = data.imap_host || '';
                document.getElementById('email-imap-port').value = data.imap_port || 993;
                document.getElementById('email-imap-username').value = data.imap_username || '';
                document.getElementById('email-imap-password').value = ''; // Don't populate password
                document.getElementById('email-imap-ssl').checked = data.imap_use_ssl !== false; // Default true
                document.getElementById('email-imap-mailbox').value = data.imap_mailbox || 'INBOX';

                // AI reply settings
                document.getElementById('email-auto-reply-enabled').checked = data.auto_reply_enabled || false;
                document.getElementById('email-check-interval').value = data.check_interval_seconds || 300;
                document.getElementById('email-reply-signature').value = data.reply_signature || '';

                // Display timestamps
                if (data.last_sent) {
                    document.getElementById('email-last-sent-display').style.display = 'block';
                    document.getElementById('email-last-sent').textContent = new Date(data.last_sent).toLocaleString();
                } else {
                    document.getElementById('email-last-sent-display').style.display = 'none';
                }

                if (data.last_checked) {
                    document.getElementById('email-last-checked-display').style.display = 'block';
                    document.getElementById('email-last-checked').textContent = new Date(data.last_checked).toLocaleString();
                } else {
                    document.getElementById('email-last-checked-display').style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading email settings:', error);
                alert('Error loading email settings');
            }
        }

        async function saveEmailSettings() {
            try {
                const settings = {
                    // SMTP settings
                    smtp_host: document.getElementById('email-smtp-host').value,
                    smtp_port: parseInt(document.getElementById('email-smtp-port').value),
                    smtp_username: document.getElementById('email-smtp-username').value,
                    smtp_use_tls: document.getElementById('email-smtp-tls').checked,
                    smtp_use_ssl: document.getElementById('email-smtp-ssl').checked,
                    from_email: document.getElementById('email-from').value,
                    recipient_email: document.getElementById('email-recipient').value,
                    // Daily summary settings
                    summary_time: document.getElementById('email-summary-time').value + ':00',
                    timezone: document.getElementById('email-timezone').value,
                    daily_summary_enabled: document.getElementById('email-enabled').checked,
                    // IMAP settings
                    imap_enabled: document.getElementById('email-imap-enabled').checked,
                    imap_host: document.getElementById('email-imap-host').value,
                    imap_port: parseInt(document.getElementById('email-imap-port').value),
                    imap_username: document.getElementById('email-imap-username').value,
                    imap_use_ssl: document.getElementById('email-imap-ssl').checked,
                    imap_mailbox: document.getElementById('email-imap-mailbox').value,
                    // AI reply settings
                    auto_reply_enabled: document.getElementById('email-auto-reply-enabled').checked,
                    reply_signature: document.getElementById('email-reply-signature').value,
                    check_interval_seconds: parseInt(document.getElementById('email-check-interval').value)
                };

                // Only include passwords if they were entered
                const smtp_password = document.getElementById('email-smtp-password').value;
                if (smtp_password) {
                    settings.smtp_password = smtp_password;
                }

                const imap_password = document.getElementById('email-imap-password').value;
                if (imap_password) {
                    settings.imap_password = imap_password;
                }

                const response = await fetch('/api/email/settings', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(settings)
                });

                if (response.ok) {
                    alert('Email settings saved successfully!');
                    loadEmailSettings(); // Reload to show updated values
                } else {
                    alert('Error saving email settings');
                }
            } catch (error) {
                console.error('Error saving email settings:', error);
                alert('Error saving email settings');
            }
        }

        async function sendTestEmail() {
            try {
                // Save settings first
                await saveEmailSettings();

                // Send test email
                const response = await fetch('/api/email/test', {
                    method: 'POST'
                });

                const data = await response.json();

                if (response.ok) {
                    alert('Test email sent successfully! Check your inbox.');
                } else {
                    alert('Error sending test email: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error sending test email:', error);
                alert('Error sending test email: ' + error.message);
            }
        }

        async function generateEmailSignature() {
            try {
                // Show loading indicator
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = '‚è≥ Generating...';
                button.disabled = true;

                const response = await fetch('/api/email/generate-signature', {
                    method: 'POST'
                });

                const data = await response.json();

                if (response.ok && data.signature) {
                    // Populate the signature field
                    document.getElementById('email-reply-signature').value = data.signature;
                    alert('Email signature generated! Review and save if you like it.');
                } else {
                    alert('Error generating signature: ' + (data.error || 'Unknown error'));
                }

                // Restore button
                button.textContent = originalText;
                button.disabled = false;
            } catch (error) {
                console.error('Error generating signature:', error);
                alert('Error generating signature: ' + error.message);
                // Restore button
                event.target.textContent = 'ü§ñ Generate Signature from Persona';
                event.target.disabled = false;
            }
        }

        // Email User Mappings Functions
        async function loadEmailMappings() {
            try {
                const response = await fetch('/api/email/mappings');
                const mappings = await response.json();

                const listDiv = document.getElementById('email-mappings-list');

                if (mappings.length === 0) {
                    listDiv.innerHTML = '<p style="color: #666; font-style: italic;">No email mappings configured. Add one to map email addresses to users.</p>';
                    return;
                }

                let html = '<table style="width: 100%; border-collapse: collapse;">';
                html += '<thead><tr style="background: #f5f5f5; text-align: left;">';
                html += '<th style="padding: 10px; border-bottom: 2px solid #ddd;">Email Address</th>';
                html += '<th style="padding: 10px; border-bottom: 2px solid #ddd;">User Name</th>';
                html += '<th style="padding: 10px; border-bottom: 2px solid #ddd;">Notes</th>';
                html += '<th style="padding: 10px; border-bottom: 2px solid #ddd; width: 100px;">Actions</th>';
                html += '</tr></thead><tbody>';

                mappings.forEach(mapping => {
                    html += '<tr style="border-bottom: 1px solid #eee;">';
                    html += `<td style="padding: 10px;">${mapping.email_address}</td>`;
                    html += `<td style="padding: 10px;"><strong>${mapping.user_name}</strong></td>`;
                    html += `<td style="padding: 10px;">${mapping.notes || '<span style="color: #999;">-</span>'}</td>`;
                    html += `<td style="padding: 10px;">`;
                    html += `<button onclick="deleteEmailMapping(${mapping.id})" style="background: #e74c3c; padding: 5px 10px; font-size: 12px;">Delete</button>`;
                    html += `</td>`;
                    html += '</tr>';
                });

                html += '</tbody></table>';
                listDiv.innerHTML = html;

            } catch (error) {
                console.error('Error loading email mappings:', error);
                document.getElementById('email-mappings-list').innerHTML = '<p style="color: #e74c3c;">Error loading mappings</p>';
            }
        }

        function showAddMappingForm() {
            document.getElementById('add-mapping-form').style.display = 'block';
            document.getElementById('new-mapping-email').value = '';
            document.getElementById('new-mapping-user').value = '';
            document.getElementById('new-mapping-notes').value = '';
            document.getElementById('new-mapping-email').focus();
        }

        function cancelAddMapping() {
            document.getElementById('add-mapping-form').style.display = 'none';
        }

        async function addEmailMapping() {
            try {
                const email = document.getElementById('new-mapping-email').value.trim();
                const userName = document.getElementById('new-mapping-user').value.trim();
                const notes = document.getElementById('new-mapping-notes').value.trim();

                if (!email || !userName) {
                    alert('Email address and user name are required');
                    return;
                }

                const response = await fetch('/api/email/mappings', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        email_address: email,
                        user_name: userName,
                        notes: notes
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    cancelAddMapping();
                    loadEmailMappings();
                    alert('Email mapping added successfully!');
                } else {
                    alert('Error adding mapping: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error adding mapping:', error);
                alert('Error adding mapping: ' + error.message);
            }
        }

        async function deleteEmailMapping(id) {
            if (!confirm('Are you sure you want to delete this email mapping?')) {
                return;
            }

            try {
                const response = await fetch(`/api/email/mappings/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    loadEmailMappings();
                    alert('Email mapping deleted successfully');
                } else {
                    alert('Error deleting mapping');
                }
            } catch (error) {
                console.error('Error deleting mapping:', error);
                alert('Error deleting mapping: ' + error.message);
            }
        }

        // Email Logs Functions
        async function loadEmailLogs() {
            try {
                const direction = document.getElementById('log-filter-direction').value;
                const type = document.getElementById('log-filter-type').value;
                const status = document.getElementById('log-filter-status').value;

                // Build query string
                const params = new URLSearchParams();
                if (direction) params.append('direction', direction);
                if (type) params.append('type', type);
                if (status) params.append('status', status);
                params.append('limit', 50);  // Show last 50 logs

                const response = await fetch(`/api/email/logs?${params.toString()}`);
                const data = await response.json();

                const listDiv = document.getElementById('email-logs-list');

                if (!data.logs || data.logs.length === 0) {
                    listDiv.innerHTML = '<p style="color: #666; font-style: italic;">No email logs found. Email activity will appear here once emails are sent or received.</p>';
                    return;
                }

                let html = '<div style="background: #f5f5f5; padding: 10px; border-radius: 8px; margin-bottom: 10px;">';
                html += `<strong>Showing ${data.logs.length} of ${data.total} logs</strong>`;
                html += '</div>';

                data.logs.forEach(log => {
                    const timestamp = new Date(log.timestamp).toLocaleString();
                    const directionIcon = log.direction === 'received' ? 'üì•' : 'üì§';
                    const statusColor = log.status === 'success' ? '#2ecc71' : '#e74c3c';
                    const statusIcon = log.status === 'success' ? '‚úì' : '‚úó';

                    // Type badge color
                    let typeBadgeColor = '#3498db';
                    if (log.email_type === 'summary') typeBadgeColor = '#9b59b6';
                    else if (log.email_type === 'test') typeBadgeColor = '#f39c12';
                    else if (log.email_type === 'reply') typeBadgeColor = '#2ecc71';

                    html += '<div style="background: white; border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px;">';

                    // Header row
                    html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">';
                    html += `<div style="display: flex; align-items: center; gap: 10px;">`;
                    html += `<span style="font-size: 24px;">${directionIcon}</span>`;
                    html += `<span style="background: ${typeBadgeColor}; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; text-transform: uppercase;">${log.email_type}</span>`;
                    html += `<span style="color: ${statusColor}; font-weight: bold;">${statusIcon} ${log.status.toUpperCase()}</span>`;
                    html += `</div>`;
                    html += `<div style="color: #999; font-size: 14px;">${timestamp}</div>`;
                    html += '</div>';

                    // Email details
                    html += '<div style="display: grid; grid-template-columns: auto 1fr; gap: 10px; margin-bottom: 10px;">';
                    html += `<strong>From:</strong><span>${log.from_email}</span>`;
                    html += `<strong>To:</strong><span>${log.to_email}</span>`;
                    if (log.subject) {
                        html += `<strong>Subject:</strong><span>${log.subject}</span>`;
                    }
                    if (log.mapped_user) {
                        html += `<strong>Mapped User:</strong><span style="background: #e3f2fd; padding: 2px 8px; border-radius: 4px;">üë§ ${log.mapped_user}</span>`;
                    }
                    if (log.error_message) {
                        html += `<strong>Error:</strong><span style="color: #e74c3c;">${log.error_message}</span>`;
                    }
                    html += '</div>';

                    // Body preview with expand button
                    if (log.body_preview) {
                        html += '<div style="margin-top: 10px;">';
                        html += '<strong>Body Preview:</strong>';
                        html += `<div id="preview-${log.id}" style="background: #f8f9fa; padding: 10px; border-radius: 4px; margin-top: 5px; max-height: 100px; overflow: hidden; white-space: pre-wrap; font-family: monospace; font-size: 12px;">${log.body_preview}</div>`;
                        if (log.full_body && log.full_body.length > 500) {
                            html += `<button onclick="toggleEmailBody(${log.id}, ${log.full_body.length > 500})" id="toggle-btn-${log.id}" style="margin-top: 5px; font-size: 12px; background: #667eea;">Show Full Body</button>`;
                            html += `<div id="fullbody-${log.id}" style="display: none; background: #f8f9fa; padding: 10px; border-radius: 4px; margin-top: 5px; max-height: 400px; overflow-y: auto; white-space: pre-wrap; font-family: monospace; font-size: 12px;">${log.full_body}</div>`;
                        }
                        html += '</div>';
                    }

                    html += '</div>';
                });

                listDiv.innerHTML = html;

            } catch (error) {
                console.error('Error loading email logs:', error);
                document.getElementById('email-logs-list').innerHTML = '<p style="color: #e74c3c;">Error loading email logs</p>';
            }
        }

        function toggleEmailBody(logId, hasFullBody) {
            const previewDiv = document.getElementById(`preview-${logId}`);
            const fullBodyDiv = document.getElementById(`fullbody-${logId}`);
            const button = document.getElementById(`toggle-btn-${logId}`);

            if (fullBodyDiv.style.display === 'none') {
                previewDiv.style.display = 'none';
                fullBodyDiv.style.display = 'block';
                button.textContent = 'Show Preview';
            } else {
                previewDiv.style.display = 'block';
                fullBodyDiv.style.display = 'none';
                button.textContent = 'Show Full Body';
            }
        }
    </script>
</body>
</html>
